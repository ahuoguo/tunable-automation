# Tunable Automation

Artifact for the paper "Tunable Automation in Automated Program Verification"

## Dependencies

We require a working version of `rustup`, `python3`, `ninja`, as Verus and Mariposa depend on them.

## Installation

Clone this repo with the following:

```
git clone https://github.com/ahuoguo/tunable-automation.git
cd tunable-automation
git submodule update --init --remote --filter=blob:none
```

## Minimizing Verus Projects

We do not include scripts to minimize several Verus project as they can take days. We provide the logs and minimized projects under `experiments/minimized`, the minimized projects after broadcasting.

Here's the path of the logs for minimization:

```
./experiments/broadcast-from-main/verified-ironkv/ironsht/src/min.log
./experiments/broadcast-from-main/verified-betrfs/Splinter/src/min-after-brd.log
./experiments/broadcast-from-main/anvil/src/min-after-brd.log
./experiments/broadcast-from-main/verified-storage/osdi25/capybaraKV/brd-from-main.log1
./experiments/minimized/verified-ironkv/ironsht/src/min.log
./experiments/minimized/verified-betrfs/Splinter/src/min.log
./experiments/minimized/anvil/src/min.log
./experiments/minimized/verified-storage/osdi25/capybaraKV/capybarakv/src/deps_hack/min.log1
./experiments/all-triggers/verified-ironkv-min/ironsht/src/min-at.log
```

### Running Minimization by Yourself

The VerusMinimizer corresponding to each project is in the `verus/` folder. An example to use VerusMinimizer is

```
cd verus/minimizer/source/tools/minimize
cargo run --release -- -d ./tmp <path-to-tunable-automation>/experiments/original/verified-ironkv/ironsht/src/lib.d
```

Here, the `lib.d` file is generated by running Verus on the project with the `--emit=dep-info` flag. See more details in the `run.sh` script.

Since Anvil and VerifiedStorage needs their own `deps_hack` folder, we provide separate VerusMinimizer for them.

## Table 2 Number of Minimized Asserts

The VerusMinimizer can also count the number of asserts

```
cd verus/minimizer/source/tools/minimize 
cargo run --release -- -n <path-to-tunable-automation>/experiments/original/verified-ironkv/ironsht/src/lib.d
```

## Figure 3 Verification Time Ratio

The time logs can be replicated by `experiments/run.sh`. It will generate a `<project-name>.json` file in `experiments/original`, `experiments/minimized`, and `experiments/braodcast-from-main`.

Then go to `json-time-cmp/` and run `generate-grphs.sh`. Figure 3 should be the same as `json-time-cmp/plot_all.png`

To get the omitted runtime ratios in Splinter and Anvil, described in the captions of Figure 3, you can run:

```
python plot.py ../experiments/broadcast-from-main/splinter.json ../experiments/original/splinter.json
python plot.py ../experiments/broadcast-from-main/anvil.json ../experiments/original/anvil.json
```

The largest ratios will be printed in the terminal, for example:
```
Highest ratio of runtime_map1 to runtime_map2: 12.417095883226493
Function: kubernetes_cluster::proof::objects_in_store::anvil::kubernetes_cluster::spec::cluster::Cluster::lemma_always_each_builtin_object_in_etcd_is_well_formed
Time in runtime_map1: 43563270
Time in runtime_map2: 3508330
Highest runtime in runtime_map1: 43563270
Function: kubernetes_cluster::proof::objects_in_store::anvil::kubernetes_cluster::spec::cluster::Cluster::lemma_always_each_builtin_object_in_etcd_is_well_formed
Ratio: 12.417095883226493
```

## Figure 4 Sampled Verification Failure Time

```
cd failure-sample
./run.sh
./generate-graph.sh # This will generate `broadcast.png` corresponding to Figure 4
cd -
```

We also already include the logs from `./run.sh`, which are the under the following folders:

```
./failure-sample/ironkv/
./failure-sample/splinter/
./failure-sample/anvil/
./failure-sample/capybara/
```

So you can directly run `./generate-graph.sh` in `failure-sample/` to generate Figure 4.

## Figure 5 IronKV All Triggers

```
cd ./experiments/all-triggers/
./run.sh
cd ../../json-time-cmp
python plot.py ../experiments/all-triggers/ironkv_at_min.json ../experiments/original/ironkv.json
cd ../failure-sample
python ./plot-all-scatter.py . all_triggers all_triggers
```

Then `json-time-cmp/plot.png` corresponds to upper half Figure 5, and `failure-sample/all_triggers.png` corresponds to the lower half of Figure 5.

Similarly, we also include the logs from `./run.sh`, which are in:
```
./experiments/all-triggers/ironkv_at_min.json
./failure-sample/ironkv_at/
```

## Appendix

### Table 3 Instability Analysis with Mariposa

To replicate Table 3, run:

```
cd experiment
./mariposa.sh
```

The table information are extracted from mariposa's output, for example:
```
=== Overall Report ===

project dir:	data/projs/ironkv_minimized/base.z3
exper config:	debug
solver path:	bin/z3-4.12.5
analyzer:	default

| category   |   count | percentage   |
|------------|---------|--------------|
| stable     |     363 | 100.0%       |
| total      |     363 | 100.00 %     |
```

The logs are in `experiments/mariposa.out`
